<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.netbull.shop.statistics.dao.StatisticsDao">
    <!-- 注册用户 -->
    <select id="queryRegisterUserList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT * FROM tb_medical_patient
        <where>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(createTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(createTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	    </where>
	    <include refid="com.odchia.dao.Dao.pageComponent"/>
    </select>
    
	<select id="queryRegisterUserCount" parameterType="java.util.Map" resultType="java.lang.Long">
	    SELECT COUNT(1) FROM tb_medical_patient 
	    <where>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(createTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(createTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	    </where>
	</select>
	
	<select id="queryDRV" parameterType="java.util.Map" resultType="java.lang.Integer">
	    SELECT COUNT(1) FROM tb_medical_patient WHERE DATE_FORMAT(createTime,'%Y-%m-%d') = #{dateParam}
	</select>
	
	<select id="queryMRV" parameterType="java.util.Map" resultType="java.lang.Integer">
	    SELECT COUNT(1) FROM tb_medical_patient WHERE DATE_FORMAT(createTime,'%Y-%m') = #{dateParam}
	</select>
	
	<!-- 药店订单 -->
	<sql id="shopOrderColumn">
	    SELECT X.*,Z.shopName,P.createTime FROM tb_medicalb_order_item X 
	    LEFT JOIN tb_medicalb_order_service Y ON X.orderNumber=Y.orderNumber
	    LEFT JOIN tb_medicalb_order_payment Q ON X.orderNumber=Q.orderNumber
	    LEFT JOIN tb_medical_pharmacy Z ON X.shopId=Z.shopID
	    LEFT JOIN tb_medicalb_order_base P ON Y.orderNumber=P.orderNumber
	</sql>
	<select id="queryShopOrderList" parameterType="java.util.Map" resultType="java.util.Map">
        <include refid="shopOrderColumn"/>
        <where>
            1=1 
            <if test="shopId !=null and shopId !=''">
	            and X.shopId = #{shopId}
	        </if>
	        <if test="companyId !=null and companyId !=''">
	            and X.shopId in(select shopId from tb_medical_pharmacy where companyId =#{companyId}) 
	        </if>
	        <if test="orderNumber !=null and orderNumber !=''">
	            and Y.orderNumber=#{orderNumber}
	        </if>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(P.createTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(P.createTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	        and Y.serviceType = 5
	        and Q.payStatus = 1
	    </where>
	    <include refid="com.odchia.dao.Dao.pageComponent"/>
    </select>
    
	<select id="queryShopOrderCount" parameterType="java.util.Map" resultType="java.lang.Long">
	    SELECT COUNT(1) FROM (<include refid="shopOrderColumn"/>
	    <where>
	        1=1 
	        <if test="companyId !=null and companyId !=''">
	            and X.shopId in(select shopId from tb_medical_pharmacy where companyId =#{companyId}) 
	        </if>
             <if test="shopId !=null and shopId !=''">
	            and X.shopId = #{shopId}
	        </if>
	        <if test="orderNumber !=null and orderNumber !=''">
	            and Y.orderNumber=#{orderNumber}
	        </if>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(P.createTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(P.createTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	        and Y.serviceType = 5
	         and Q.payStatus = 1
	    </where>
	    ) as count
	</select>
	
	<!-- 医生业务统计 -->
	<sql id="doctorBusinessColumn">
	    SELECT X.id,X.orderNumber,X.patientId,X.doctorId,X.serviceType,X.serviceNumber,Z.doctorName,Y.payPrice,Y.payStatus,Y.payTime createTime
	    FROM tb_medicalb_order_service X 
	    LEFT JOIN tb_medicalb_order_payment Y ON X.orderNumber=Y.orderNumber
	    LEFT JOIN tb_medicalb_order_base A ON X.orderNumber=A.orderNumber
	    LEFT JOIN tb_medical_doctor Z ON X.doctorId=Z.doctorID
	</sql>
	<select id="queryDoctorBusinessList" parameterType="java.util.Map" resultType="java.util.Map">
	    <include refid="doctorBusinessColumn"/>
	    <where>
	        <if test="doctorId !=null and doctorId !=''">
	            and X.doctorId = #{doctorId}
	        </if>
	        <if test="creator !=null and creator !=''">
	            and Z.creator = #{creator}
	        </if>
	        <if test="payStatus !=null and payStatus !=''">
	            and Y.payStatus = #{payStatus}
	        </if>
	        <if test="orderNumber !=null and orderNumber !=''">
	            and X.orderNumber = #{orderNumber}
	        </if>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(Y.payTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(Y.payTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	        and X.serviceType in (1,2,3)
	    </where>
	     <include refid="com.odchia.dao.Dao.pageComponent"/>
	</select>
	
	<select id="queryDoctorBusinessCount" parameterType="java.util.Map" resultType="java.lang.Long">
	    SELECT COUNT(1) FROM (<include refid="doctorBusinessColumn"/>
	    <where>
	        <if test="doctorId !=null and doctorId !=''">
	            and X.doctorId = #{doctorId}
	        </if>
	        <if test="creator !=null and creator !=''">
	            and Z.creator = #{creator}
	        </if>
	        <if test="payStatus !=null and payStatus !=''">
	            and Y.payStatus = #{payStatus}
	        </if>
	        <if test="orderNumber !=null and orderNumber !=''">
	            and X.orderNumber = #{orderNumber}
	        </if>
	        <if test="startTime !=null and startTime !=''">
	            and DATE_FORMAT(Y.payTime,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
	        </if>
	        <if test="endTime !=null and endTime !=''">
	            and DATE_FORMAT(Y.payTime,'%Y-%m-%d') &lt; DATE_FORMAT(#{endTime},'%Y-%m-%d')
	        </if>
	        and X.serviceType in (1,2,3)
	    </where>
	    ) as count
	</select>
	
	<!-- 医院业务统计 -->
	<sql id="hospitalBusinessColumn">
	    SELECT C.hospitalID,D.hospitalName,A.doctorId,C.doctorName,COUNT(1) as serviceSum,SUM(B.payPrice) as servicePrice FROM tb_medicalb_order_service A 
	    LEFT JOIN tb_medicalb_order_payment B ON A.orderNumber=B.orderNumber
	    LEFT JOIN tb_medical_doctor C ON A.doctorId=C.doctorID 
	    LEFT JOIN tb_medical_hospital D ON C.hospitalID=D.hospitalID
	</sql>
	<select id="queryHospitalBusinessList" parameterType="java.util.Map" resultType="java.util.Map">
	    <include refid="hospitalBusinessColumn"/>
	    <where>
	        1=1 and D.userID in
	         <foreach collection="users" item="user" open="(" separator="," close=")">
	             #{user}   
	         </foreach>
	        <if test="hospitalID !=null and hospitalID !=''">
	            and C.hospitalID = #{hospitalID}
	        </if>
	        <if test="doctorName !=null and doctorName !=''">
	            and C.doctorName like CONCAT('%',#{doctorName},'%')
	        </if>
	        and A.doctorId>0
	        and B.payStatus=1
	        and A.serviceType in (1,2,3)
	    </where>
	    GROUP BY A.doctorId
	     <include refid="com.odchia.dao.Dao.pageComponent"/>
	</select>
	
	<select id="queryHospitalBusinessCount" parameterType="java.util.Map" resultType="java.lang.Long">
	    SELECT COUNT(1) FROM (<include refid="hospitalBusinessColumn"/>
	    <where>
	        1=1 and D.userID in
	         <foreach collection="users" item="user" open="(" separator="," close=")">
	             #{user}   
	         </foreach>
	         <if test="hospitalID !=null and hospitalID !=''">
	            and C.hospitalID = #{hospitalID}
	        </if>
	        <if test="doctorName !=null and doctorName !=''">
	            and C.doctorName like CONCAT('%',#{doctorName},'%')
	        </if>
	        and A.doctorId>0
	        and B.payStatus=1
	        and A.serviceType in (1,2,3)
	    </where>
	    GROUP BY A.doctorId
	    ) as count
	</select>
	<select id="queryConpanyPatient" parameterType="java.util.Map" resultType="java.util.Map">
		    SELECT p.*,ph.shopName FROM tb_medical_patient p,tb_medicalb_order_service s,tb_medicalb_order_item o,tb_medical_pharmacy ph
	 		WHERE p.patientID=s.patientId AND s.orderNumber=o.orderNumber AND o.shopId=ph.shopID
	 		<if test="companyId!=null and companyId!=''">
	 			and ph.companyId=#{companyId}
	 		</if>
	 		<if test="patientName!=null and patientName!=''">
	 			and ph.companyId=#{companyId}
	 		</if>
	 		<if test="shopId!=null and shopId!=''">
	 			and ph.shopId=#{shopId}
	 		</if>
	     <include refid="com.odchia.dao.Dao.pageComponent"/>
	</select>
	
	<select id="queryConpanyPatientCount" parameterType="java.util.Map" resultType="java.lang.Long">
	    	SELECT count(*) FROM tb_medical_patient p,tb_medicalb_order_service s,tb_medicalb_order_item o,tb_medical_pharmacy ph
	 		WHERE p.patientID=s.patientId AND s.orderNumber=o.orderNumber AND o.shopId=ph.shopID
	 		<if test="companyId!=null and companyId!=''">
	 			and ph.companyId=#{companyId}
	 		</if>
	 		<if test="patientName!=null and patientName!=''">
	 			and ph.companyId=#{companyId}
	 		</if>
	 		<if test="shopId!=null and shopId!=''">
	 			and ph.shopId=#{shopId}
	 		</if>
	</select>
	
</mapper>