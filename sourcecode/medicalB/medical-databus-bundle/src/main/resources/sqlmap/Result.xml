<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.netbull.shop.databus.questionnaire.model.Result">

	<insert id="save" parameterType="com.netbull.shop.databus.questionnaire.model.Result" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tb_questionnaire_result(qnId, doctorId, patientId, commitTime, state,deputeDoctor)
		VALUES (#{qnId}, #{doctorId}, #{patientId}, NOW(), 1,#{deputeDoctor})
	</insert>
	
	<select id="find_exceptionResults" parameterType="long" resultType="com.netbull.shop.databus.questionnaire.dto.ExceptionResult">
		select
			b.id rId,
			b.commitTime commitTime, 
			(select c.patientName from tb_medical_patient c where c.patientID = b.patientId) patientName,
			(select IFNULL(d.patientSex, '未知') from tb_medical_patient d where d.patientID = b.patientId) gender,
			IFNULL(g.hospitalName, '未知') hospitalName
		from
			tb_questionnaire_patient_mapping a, tb_questionnaire_result b
			left join tb_medical_patient_doctor e on e.patientID = b.patientId
			left join tb_medical_doctor f on f.doctorID = e.doctorID
			left join tb_medical_hospital g on g.hospitalID = f.hospitalID
		where
			a.qnId = b.qnId and a.patientId = b.patientId and a.doctorId = #{doctorId}
			and b.id in (select DISTINCT t.rId from tb_questionnaire_result_detail t where t.exceptionFlag = 1)
	</select>
	
	<select id="find_DoctorResults" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT r.id,qnId,q.name,r.doctorId,r.patientId,p.patientName,r.commitTime,IFNULL(r.deputeDoctor,0) deputeDoctor,IFNULL(d.doctorName,'无') deputeDoctorName,IFNULL(e.exnum,0) exnum
		 FROM tb_questionnaire_result r
		LEFT JOIN tb_questionnaire q ON q.id=r.qnId
		LEFT JOIN tb_medical_doctor d ON r.deputeDoctor=d.doctorID
		LEFT JOIN tb_medical_patient p ON r.patientId=p.patientID
		LEFT JOIN 
		(SELECT COUNT(1) exnum,rid FROM tb_questionnaire_result_detail WHERE exceptionFlag=1 GROUP BY rid) e ON r.id=e.rid
		<where>
			 <if test="doctorId != null and doctorId !=''">
			     and r.doctorId = ${doctorId}
			</if>
		    <if test="patientId != null and patientId !=''">
			     and r.patientId = ${patientId}
			</if>
		</where>
		 ORDER BY r.commitTime DESC limit ${startIndex}, ${pageSize}
	</select>
	<select id="find_DoctorResultsTotal" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT count(1) FROM tb_questionnaire_result r
		LEFT JOIN tb_questionnaire q ON q.id=r.qnId
		LEFT JOIN tb_medical_doctor d ON r.deputeDoctor=d.doctorID
		LEFT JOIN tb_medical_patient p ON r.patientId=p.patientID
		<where>
			 <if test="doctorId != null and doctorId !=''">
			     and r.doctorId = ${doctorId}
			</if>
		    <if test="patientId != null and patientId !=''">
			     and r.patientId = ${patientId}
			</if>
		</where>
	</select>
	<select id="find_DoctorquesPatient" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT a.patientId,a.doctorId,a.lastBindTime, p.patientSex,p.patientName,p.patientAge FROM
		(SELECT DISTINCT patientId,doctorId,MAX(bindTime) lastBindTime FROM tb_questionnaire_patient_mapping GROUP BY patientId,doctorId) a
		LEFT JOIN tb_medical_patient p ON p.patientID=a.patientId
		where a.doctorId=#{doctorId}
		 ORDER BY a.lastBindTime DESC limit ${startIndex}, ${pageSize}
	</select>
	<select id="find_DoctorquesPatientTotal" parameterType="java.util.Map" resultType="java.lang.Integer">
		SELECT count(1) FROM
		(SELECT DISTINCT patientId,doctorId,MAX(bindTime) lastBindTime FROM tb_questionnaire_patient_mapping GROUP BY patientId,doctorId) a
		LEFT JOIN tb_medical_patient p ON p.patientID=a.patientId
		where a.doctorId=#{doctorId}
	</select>
</mapper>