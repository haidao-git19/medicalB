<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.netbull.shop.manage.weixin.dao.EvaluateDao">

    <select id="queryList" parameterType="java.util.Map" resultType="java.util.Map">
        select X.id,X.objectID,X.objectType,X.evaluatorID,X.score,X.content,X.createTime,
        DATE_FORMAT(X.createTime,'%Y-%m-%d %H:%i:%s') evaluateTime,Y.nickName,Y.realName,Y.age,Y.sex,Y.icon,
        	CASE 
        		WHEN (X.betterRate &lt; 0.9) THEN 0.9
        		ELSE X.betterRate END betterRate
        from tb_medical_evaluate X left join tb_medical_user_info Y on X.evaluatorID=Y.userID
        <where>
            <if test="objectID !=null and objectID !=''">
                and X.objectID = #{objectID}
            </if>
            <if test="objectType !=null and objectType !=''">
                and X.objectType = #{objectType}
            </if>
        </where>
    </select>
	
    <select id="queryBetterRate" parameterType="java.util.Map" resultType="float">
        select truncate(SUM(e.betterRate)/COUNT(1),2) betterRate from tb_medical_evaluate e where e.objectType in (1,2) 
        and e.evaluatorID = #{doctorID};
    </select>
    
    <insert id="save" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="id">
        insert tb_medical_evaluate(objectID,evaluatorID,score,content,objectType,createTime) 
        	values(#{objectID},#{evaluatorID},#{score},#{content},#{objectType},now())
    </insert>
    
    <update id="updateBetterRate" parameterType="java.util.Map" statementType="CALLABLE">
       call UPDATE_EVALUATE_BETTERRATE(#{objectID,jdbcType=VARCHAR,mode=IN},#{objectType,jdbcType=VARCHAR,mode=IN})
    </update>
</mapper>