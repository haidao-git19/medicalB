<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.netbull.shop.manage.weixin.dao.GroupDao">

    <select id="queryFriends" parameterType="java.util.Map" resultType="java.util.Map">
        <!-- 查询发起添加我为好友的医生列表信息 -->
         (select D.doctorID,D.doctorLevel,h.hospitalName,s.attrvalue,D.avatar,U.true_name,U.phone,(SELECT g.state FROM tb_doctor_group g WHERE g.initiatorID=D.doctorID and g.recipientID=#{operatorID} ) state ,'1' as type from tb_medical_doctor D LEFT JOIN tb_medical_hospital h on D.hospitalID = h.hospitalID LEFT JOIN tb_medical_section s on D.sectionID = s.id
        	inner join vauth.user_info U on D.loginID=U.id   
        	<where>
        	    <if test="realName !=null and realName !=''">
        	        and U.true_name like CONCAT("%",#{realName},"%")
        	    </if>
        	    <if test="phone !=null and phone !=''">
        	        and U.phone=#{phone}
        	    </if>
        	    <if test="operatorID !=null and operatorID !=''">
        	        and D.doctorID in (
		        	SELECT initiatorID friendID FROM tb_doctor_group 
		        	WHERE recipientID=#{operatorID})
        	    </if>
        	</where>
        	)
        	UNION
        	(select D.doctorID,D.doctorLevel,h.hospitalName,s.attrvalue,D.avatar,U.true_name,U.phone,(SELECT g.state FROM tb_doctor_group g WHERE g.recipientID=D.doctorID and g.initiatorID=#{operatorID}) state,'0' as type  from tb_medical_doctor D LEFT JOIN tb_medical_hospital h on D.hospitalID = h.hospitalID LEFT JOIN tb_medical_section s on D.sectionID = s.id
        	inner join vauth.user_info U on D.loginID=U.id   
        	<where>
        	    <if test="realName !=null and realName !=''">
        	        and U.true_name like CONCAT("%",#{realName},"%")
        	    </if>
        	    <if test="phone !=null and phone !=''">
        	        and U.phone=#{phone}
        	    </if>
        	    <if test="operatorID !=null and operatorID !=''">
        	        and D.doctorID in (
		        	SELECT recipientID friendID FROM tb_doctor_group 
		        	WHERE initiatorID=#{operatorID}
		        	)
        	    </if>
        	</where>
        	);
    </select>
    
    <select id="queryOne" parameterType="java.util.Map" resultType="java.util.Map">
        select * from tb_doctor_group 
        <where>
             <if test="initiatorID !=null and initiatorID !=''">
  	            and initiatorID=#{initiatorID}
  	        </if>
  	        <if test="recipientID !=null and recipientID !=''">
  	            and recipientID=#{recipientID}
  	        </if>
        </where>
    </select>
    
  	<insert id="save" parameterType="java.util.Map">
  	    insert tb_doctor_group(initiatorID,recipientID,state) values(#{initiatorID},#{recipientID},'0')
  	</insert>
  	
  	<update id="update" parameterType="java.util.Map">
  	    update tb_doctor_group
  	    <set>
  	        <if test="state !=null and state !=''">
  	            state = #{state}
  	        </if>
  	    </set>
  	    <where>
  	        <if test="initiatorID !=null and initiatorID !=''">
  	            and initiatorID=#{initiatorID}
  	        </if>
  	        <if test="recipientID !=null and recipientID !=''">
  	            and recipientID=#{recipientID}
  	        </if>
  	    </where>
  	</update>
	
</mapper>