var cartItemTypes={1:{name:"普通商品",showName:""},3:{name:"套餐",showName:""},6:{name:"赠品",showName:'<span class="red">[赠品]</span>'},7:{name:"换购",showName:'<span class="red">[换购]</span>'}};function addToCart(c,f,b,h,g,a){if(c!=1&&c!=3){return}if(!/^\d*$/g.test(f)){return}if(!/^\d*$/g.test(h)){return}if(!/^\d*$/g.test(b)){return}if(!a||a==1){a=0}if(a>0&&b>a){b=a}if(b<=0){return}var e=readCart();var j={iy:parseInt(c),ri:parseInt(f),ic:parseInt(b),ii:parseInt(h),limitBuyNum:a};if(e){for(var d in e){if(e[d].ii==j.ii&&e[d].iy==j.iy){e[d].ic=parseInt(e[d].ic)+parseInt(j.ic);writeCart(e);if(!g){showAddCartDiv(c,f,b,h)}return}}e[e.length]=j;writeCart(e)}else{writeCart([j])}if(!g){showAddCartDiv(c,f,b,h)}}function showAddCartDiv(b,c,a,e){$.ajaxSetup({cache:true});var d=new Date().format("yyMMddhhmm");a=parseInt(a);if($("[name='product_amount']").length>0){a=0;$("[name='product_amount']").each(function(){a+=parseInt($(this).attr("value"))})}a=a<0?1:a;$.ajax({type:"GET",url:"http://www.111.com.cn/interfaces/item/itemPrice.action?itemids="+e+"&_="+d.substring(0,d.length-1),dataType:"jsonp",jsonp:"jsoncallback",jsonpCallback:"cbprice",success:function(h){if(!h){cleanCart();return}var g=h[0];var f;f=g.img4;$("#addCartWin > div > div > img").attr("src",f);$("#addCartWin > div > font").html(a+"件商品加入购物车");$($("#addCartWin > div > div > span")[0]).html("加入数量："+a);$("#addCartWin > div > div > span > span").html('<i class="qian">&yen;</i>'+(g.price*a).toFixed(2));$("#addCartWin > div > div > em").html(g.name.replace(/【-.*】/,""));$("#addCartWin").css("position","absolute");$("#addCartWin").css("margin-top","0");$("#addCartWin").css("z-index","10000");$("#addCartWin").css("top",($(window).scrollTop()+$(window).height()/4)+"px");$("#addCartInfo").css("position","static");$("#addCartInfo").show();$.ajaxSetup({cache:false})}})}function readCart(){var c=$.cookie("cartItem");try{if(c){c=c.replace('"',"").replace('"',"");c=c.replace("$iy$:2","$iy$:1");var rel=eval(c.replace(/\$/gm,'"'));if(c.match(/.*\$iy\$:.*?,.*\$ri\$:.*?,/)){return rel}}}catch(e){}cleanCart();return null}function writeCart(a){$.cookie("cartItem",$.stringifyJSON(a).replace(/\"/gm,"$"),{path:"/",domain:".111.com.cn",expires:30});if($(".shoppingCart").size()>0){$("#minicart_list").parent().prev().children().html("购物车("+countCart()+")")}else{$("#minicart_list").parent(".mod_minicart").children(".mini_cart_btn").find(".cart_num").html(countCart())}if($(".float_box .f_wei").size()>0){$(".float_box .f_wei").html(countCart())}}function countCart(){var c=readCart();if(!c){return 0}var b=0;for(var a=0;a<c.length;a++){b+=c[a].ic}return b}function accMul(d,b){var a=0,f=d.toString(),c=b.toString();try{a+=f.split(".")[1].length}catch(g){}try{a+=c.split(".")[1].length}catch(g){}return Number(f.replace(".",""))*Number(c.replace(".",""))/Math.pow(10,a)}function accAdd(f,d){var c,b,a;try{c=f.toString().split(".")[1].length}catch(g){c=0}try{b=d.toString().split(".")[1].length}catch(g){b=0}a=Math.pow(10,Math.max(c,b));return(f*a+d*a)/a}function showCart(a){if(!a){if($("#minicart_list").css("display")=="block"){return}}var f=readCart();if(!f){cleanCart();$("#minicart_list").show();return}else{$("#minicart_list .none_tips").hide();$("#minicart_list .checkout_box").show();$("#minicart_list .list_detail > ul").show();$("#miniCart_p2").hide()}var e={},d="",b="";for(var g=0;g<f.length;g++){if(f[g].iy==7){if(b!=""){b+=","}b+=f[g].ii}if(d!=""){d+=","}d+=f[g].ii}$.ajaxSetup({cache:true});if(b.length>1){loadItemData_(f,e,d,b)}else{doItemData_(f,e,d,"")}}function loadItemData_(d,c,b,a){$.ajax({type:"GET",dataType:"jsonp",jsonp:"jsoncallback",jsonpCallback:"cbprice",url:"http://www.111.com.cn/front/promotion/product/redePrice.action?itemId="+a,async:false,success:function(e){doItemData_(d,c,b,e)}})}function doItemData_(f,c,d,a){var b=new Date().format("yyMMddhhmm");var e=0;$.ajax({type:"GET",url:"http://www.111.com.cn/interfaces/item/itemPrice.action?itemids="+d+"&_="+b.substring(0,b.length-1),dataType:"jsonp",jsonp:"jsoncallback",jsonpCallback:"cbprice",success:function(k){for(var r=0;r<f.length;r++){var q=f[r];$.each(k,function(s,t){if(q.ii==t.id){f[r].pic=t.img5;c[q.ii+"_"+q.iy]={};if(q.iy==7){var u=0;if(a!=""&&a[q.ii]!=-1){u=a[q.ii]}else{u=t.price}c[q.ii+"_7"]["price"]=u;e=accAdd(e,accMul(u,q.ic))}else{if(q.iy==6){c[q.ii+"_"+q.iy]["price"]=0}else{e=accAdd(e,accMul(t.price,q.ic));c[q.ii+"_"+q.iy]["price"]=t.price}}c[q.ii+"_"+q.iy]["name"]=t.name;c[q.ii+"_"+q.iy]["saletype"]=t.saletype}})}$("#minicart_list > div > div > p > em").html("&yen;"+parseInt(e*100)/100);var p=$("#minicart_list > div > ul")[0];var n=0;$(p).html("");try{for(var l=f.length-1;l>=0;l--){var q=f[l];var j="http://www.111.com.cn/product/"+q.ri+".html";if(q.iy==3){j+="#"+q.ii+'" onclick="$(\'#'+q.ii+"').click();"}var m=q.pic;var h=c[q.ii+"_"+q.iy]["name"];var g="minus";if(q.ic<=1){g="minusDisable"}$(p).append('<li><a traget="_blank" class="pro_img" href="'+j+'"><img heigth="40" width="40"  src="'+m+'"  onerror="imgERROR(this,\'no_pic_50_50.jpg\');"/></a><a traget="_blank" class="pro_name" href="'+j+'">'+cartItemTypes[q.iy].showName+h+'</a><span class="pro_price">&yen;'+parseFloat(c[q.ii+"_"+q.iy]["price"])+'</span><div class="num_box"><b name="editName_'+q.ii+'" class="'+g+'" onclick="updateCart(-1,'+q.ii+","+q.iy+')"></b><input type="text" class="minicart_num" value="'+q.ic+'"><b name="editName_'+q.ii+'" class="plus" onclick="updateCart(1,'+q.ii+","+q.iy+')"></b><a target="_self" style="display:none;" href="javascript:removeCart('+q.ii+","+q.iy+')">删除</a></div></li>');n+=parseInt(q.ic)}$("#minicart_list > div > div > p > span > em").html(n);if($(".shoppingCart").size()>0){$("#minicart_list").parent().prev().children().html("购物车("+n+")")}else{$("#minicart_list").parent(".mod_minicart").children(".mini_cart_btn").find(".cart_num").html(n)}$("#minicart_list").show()}catch(o){showCart()}$.ajaxSetup({cache:false})}})}function updateCart(b,e,a){if(a==6||a==7){return}var f=readCart();for(var d=0;d<f.length;d++){var g=f[d];if(g.ii==e&&g.iy==a){g.ic=parseInt(g.ic)+parseInt(b);if(g.ic<=0){removeCart(g.ii,g.iy);showCart(1);return}if(g.ic<g.limitBuyNum){g.ic=g.limitBuyNum}}}writeCart(f);showCart(1)}function removeCart(b,a){}function cleanCart(){$("#minicart_list .list_detail > ul").hide();$("#minicart_list .checkout_box").hide();$("#minicart_list .none_tips").show();$("#miniCart_p2").show();$("#minicart_list > div > ul").html("");$("#minicart_list > div > div > p > span > em").html(0);$("#minicart_list > div > div > p > em").html("&yen;0.00");if($(".shoppingCart").size()>0){$("#minicart_list").parent().prev().children().html("购物车(0)")}else{$("#minicart_list").parent(".mod_minicart").children(".mini_cart_btn").find(".cart_num").html("0")}$.cookie("cartItem",null,{path:"/",domain:".111.com.cn"});$("#minicart_list .list_detail > ul").hide();$("#minicart_list .checkout_box").hide();$("#minicart_list .none_tips").show()}function setAddressCity(a){if($.cookie("provinceId")==a){return}$.cookie("provinceId",a,{path:"/",domain:".111.com.cn",expires:15});window.location.reload()}function checkProvinceId(d){if(d==null){return false}var c=$("#headerAllProvince > li > a");for(var b=0;b<c.length;b++){var a=$(c[b]).attr("id");if(!a){continue}if(a.replace("p_","")==d){return true}}return false}$(document).ready(function(){var d=readCart();var c=[];var b=0;var a=$.cookie("provinceId");if(!checkProvinceId(a)){$.cookie("provinceId","1",{path:"/",domain:".111.com.cn",expires:30})}$(".mod_minicart , .shoppingCart").mouseover(function(){stopPropagation(this.enent);showCart()});$(".mod_minicart , .shoppingCart").bind("mouseleave",function(){stopPropagation(this.enent);$("#minicart_list").hide()});if($(".shoppingCart").size()>0){$("#minicart_list").parent().prev().children().html("购物车("+countCart()+")")}else{$("#minicart_list").parent(".mod_minicart").children(".mini_cart_btn").find(".cart_num").html(countCart())}});